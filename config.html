<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>XYZObywatel v2.0 – konfigurator</title>
  <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">

  <link rel="icon" type="image/png" href="assets/icons/icon-192.png">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">

  <link rel="manifest" href="assets/manifest.json">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body{margin:0;font-family:system-ui;background:radial-gradient(circle at top,#1b1f3b,#05060f);color:#fff}
.container{max-width:420px;margin:auto;padding:16px}
h1{text-align:center;margin:16px 0;font-weight:600}
.card{background:rgba(255,255,255,.05);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:0 0 25px rgba(140,100,255,.25)}
label{font-size:12px;opacity:.8}
input,select{width:100%;margin:6px 0 12px;padding:12px;border-radius:12px;border:none;background:rgba(0,0,0,.4);color:#fff;font-size:14px}
button{width:100%;padding:14px;border-radius:14px;border:none;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;font-size:16px;font-weight:600}
.warning{text-align:center;font-size:11px;opacity:.5;margin-top:12px}
</style>
  <script defer src="assets/pwa.js"></script>
</head>

<body>

<div class="container" id="form">
<h1>konfigurator Mobywatel</h1>

<div class="card">
<label>Imię</label><input id="imie">
<label>Nazwisko</label><input id="nazwisko">
<label>Płeć</label>
<select id="plec"><option>MĘŻCZYZNA</option><option>KOBIETA</option></select>
<label>Data urodzenia</label><input type="date" id="dataUrodzenia">
<label>PESEL</label><input id="pesel" readonly>
<label>Seria i numer mDowodu</label><input id="seria" placeholder="np. MWYC 24561">
<label>Data wydania</label><input id="wydanie" value="14.07.2023" readonly>
<label>Termin ważności</label><input id="waznosc" value="14.07.2028" readonly>
</div>

<div class="card">
<label>Imię ojca</label><input id="ojciec">
<label>Imię matki</label><input id="matka">
<label>Obywatelstwo</label><input id="obywatelstwo" value="POLSKIE">
<label>Miejsce urodzenia</label><input id="miejsce">
<label>Kraj urodzenia</label><input id="kraj" value="Polska">
</div>

<div class="card">
<label>Ulica i numer</label><input id="ulica">
<label>Kod pocztowy</label><input id="kod">
<label>Miasto</label><input id="miasto">
<label>Data zameldowania</label><input type="date" id="zameldowanie">
</div>

<div class="card">
<label>Nazwisko rodowe (Twoje)</label><input id="rodowe">
<label>Nazwisko rodowe ojca</label><input id="rodoweOjca">
<label>Nazwisko rodowe matki</label><input id="rodoweMatki">
</div>

<div class="card">
<label>Zdjęcie</label><input type="file" id="photo" accept="image/*">
</div>

<div class="card" id="accessGate">
  <label>Kod dostępu</label>
  <input id="accessCode" placeholder="Wpisz kod">
  <div id="codeErr" style="display:none;color:#f87171;font-size:12px;">Niepoprawny kod</div>
</div>


<button id="genBtn" type="button" disabled style="opacity:.5">GENERUJ</button>
<div class="warning">WERSJA EKSPERYMENTALNA / DEMO</div>
</div>

<script>

const ALLOWED_HASHES = [
  "1f8aea262077b28713a63e65d3ef5df8172d2142f6eeaaf9327bf2866c9711db", 
  "9c3f4bdccc1bde8827b485ecbcfcd3f9280898efeba3d63bb3e322810886628b", 
  "3d41ba74d651f2cc3ce85c4b583f9392b7a56995a2d41fa53ad28e33c80eb8b6", 
  "494854fdf3edaec9cab146803cf641d946fd817b3d9542f4e205d26a4b90f140", 
  "90198a971017448f9eafe4df59b5ac305ba54f0316e8d07196239ff16aca076c", 
  "0980a684b8812ef54c705dc52e56460477b29f4045d53a7c65a6879896dfc871", 
  "20f5d6a3f71eae99d049c1fb3216a65040dac858d5d8ee75ab541c49daa4b52e", 
  "8c4758b3dac1f15a9fee409594558a4f0d4779642cb4db05420c424974f26509", 
  "c430933d91f5f666d60f8779b009e5ad4345398864bffc42347a88b90b43d719", 
  "dbde46fbb849658e3393265109c7068ac7e0fb8b84a86e8a4bb5cc1e601775b2", 
  "af3873ef8a377016545b9956e71304af45fb2b27c74d75bb3a96f5b30a8cd3c7"  
];

/** 2) Pomocnicze */
async function sha256hex(text){
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

function getUsedSet(){
  try {
    return new Set(JSON.parse(localStorage.getItem("used_code_hashes") || "[]"));
  } catch {
    return new Set();
  }
}

function saveUsedSet(set){
  localStorage.setItem("used_code_hashes", JSON.stringify([...set]));
}

/** 3) PESEL (iOS-safe) */
function generateDemoPESEL(dateStr, male=true){
  if(!dateStr) return "";
  const parts = dateStr.split("-");
  if(parts.length !== 3) return "";
  const Y = Number(parts[0]), M = Number(parts[1]), D = Number(parts[2]);
  if(!Y || !M || !D) return "";
  const base = String(Y%100).padStart(2,'0') + String(M).padStart(2,'0') + String(D).padStart(2,'0');
  const rand = Math.floor(1000 + Math.random() * 9000);
  return base + rand + (male ? 1 : 0);
}

function toPLDate(dateStr){
  if(!dateStr) return "";
  const [y,m,d] = dateStr.split("-");
  return `${d}.${m}.${y}`;
}

/** 4) Logika bramki + generowanie */
window.addEventListener("DOMContentLoaded", () => {
  const dataUrodzeniaEl = document.getElementById("dataUrodzenia");
  const plecEl = document.getElementById("plec");
  const peselEl = document.getElementById("pesel");

  const codeInput = document.getElementById("accessCode");
  const codeErr = document.getElementById("codeErr");
  const genBtn = document.getElementById("genBtn");

  // PESEL onchange
  if (dataUrodzeniaEl && plecEl && peselEl) {
    dataUrodzeniaEl.addEventListener("change", () => {
      peselEl.value = generateDemoPESEL(dataUrodzeniaEl.value, plecEl.value === "MĘŻCZYZNA");
    });
  }

  // Walidacja kodu (jednorazowy)
  async function validateCode(){
    const v = (codeInput?.value || "").trim();
    if(!v){
      genBtn.disabled = true; genBtn.style.opacity = "0.5";
      codeErr.style.display = "none";
      return;
    }

    const h = await sha256hex(v);
    const used = getUsedSet();

    const ok = ALLOWED_HASHES.includes(h) && !used.has(h);

    genBtn.disabled = !ok;
    genBtn.style.opacity = ok ? "1" : "0.5";
    codeErr.style.display = ok ? "none" : "block";
    // tekst błędu (zajebiście pomocne)
    codeErr.textContent = ALLOWED_HASHES.includes(h) && used.has(h)
      ? "Ten kod został już użyty"
      : "Niepoprawny kod";
  }

  codeInput.addEventListener("input", validateCode);

  // Klik GENERUJ
  genBtn.addEventListener("click", async () => {
    const code = (codeInput.value || "").trim();
    const h = await sha256hex(code);
    const used = getUsedSet();

    if(!ALLOWED_HASHES.includes(h) || used.has(h)){
      codeErr.style.display = "block";
      codeErr.textContent = used.has(h) ? "Ten kod został już użyty" : "Niepoprawny kod";
      return;
    }

    // budowa danych (bez polegania na globalnych zmiennych id — stabilne na iOS)
    const v = (id) => document.getElementById(id)?.value ?? "";

    const data = {
      imie: v("imie"),
      nazwisko: v("nazwisko"),
      plec: v("plec"),
      data: toPLDate(v("dataUrodzenia")),
      pesel: v("pesel"),
      seria: v("seria"),
      wydanie: v("wydanie"),
      waznosc: v("waznosc"),
      ojciec: v("ojciec"),
      matka: v("matka"),
      obywatelstwo: v("obywatelstwo"),
      miejsce: v("miejsce"),
      kraj: v("kraj"),
      ulica: v("ulica"),
      kod: v("kod"),
      miasto: v("miasto"),
      zameldowanie: v("zameldowanie"),
      rodowe: v("rodowe"),
      rodoweOjca: v("rodoweOjca"),
      rodoweMatki: v("rodoweMatki"),
      photo: null,

      // zapisujemy hash kodu (przyda się jeśli kiedyś dodasz bramkę na card.html)
      _accessHash: h
    };

    // foto
    const f = document.getElementById("photo")?.files?.[0];
    const finish = () => {
      localStorage.setItem("mobywatel_user", JSON.stringify(data));

      // OZNACZ KOD JAKO UŻYTY (jednorazowy)
      used.add(h);
      saveUsedSet(used);

      location.href = "/card.html";
    };

    if (f) {
      const r = new FileReader();
      r.onload = () => { data.photo = r.result; finish(); };
      r.readAsDataURL(f);
    } else {
      finish();
    }
  });

  // pierwszy run walidacji
  validateCode();
});
</script>


</body>
</html>
